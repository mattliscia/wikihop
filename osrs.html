<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OSRS Wiki Game â€“ srcdoc embed</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="header.js"></script>
</head>
<body class="bg-slate-900 text-slate-100">


  <main class="p-4">
    <div class="max-w-7xl mx-auto">
      <!-- Mobile Layout: Sidebar elements stacked above iframe -->
      <div class="block lg:hidden space-y-3 mb-4">
        <!-- Game Stats - Mobile -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-3">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-sm font-semibold text-yellow-400">Game Stats</h3>
            <button id="btnNewMobile" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">New round</button>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="bg-slate-700 rounded p-2">
              <div class="text-slate-400">Clicks</div>
              <div class="font-bold text-yellow-400" id="clicksMobile">0</div>
            </div>
            <div class="bg-slate-700 rounded p-2">
              <div class="text-slate-400">Time</div>
              <div class="font-bold text-purple-400" id="timerMobile">0:00</div>
            </div>
          </div>
        </div>
        
        <!-- Destination Info - Mobile -->
        <div id="destinationInfoMobile" class="bg-slate-800 rounded-lg border border-slate-700 p-3">
          <h2 class="text-sm font-bold mb-2">Target Page:</h2>
          <div class="flex items-center gap-2 mb-2">
            <div id="destImageMobile" class="hidden">
              <img id="destImageSrcMobile" class="w-8 h-8 object-contain rounded" alt="Destination image">
            </div>
            <a href="" class="text-sm font-bold text-green-400 flex-1 hover:text-green-300" id="destTitleMobile" target="_blank"></a>
          </div>
          <p id="destDescriptionMobile" class="text-slate-300 text-xs leading-relaxed">
            Click "New round" to start a game and see your destination here.
          </p>
        </div>
        
        <!-- Navigation History - Mobile -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-3">
          <h3 class="text-sm font-semibold text-amber-400 mb-2">Your Path</h3>
          <div id="pathHistoryMobile" class="space-y-1 max-h-24 overflow-y-auto">
            <p class="text-slate-400 text-xs">No pages visited yet.</p>
          </div>
        </div>
      </div>

      <!-- Desktop Layout: Sidebar and main content side by side -->
      <div class="hidden lg:flex gap-4">
        <!-- Main Content Area (75%) -->
        <div class="flex-1">
          <div class="rounded-xl overflow-hidden shadow ring-1 ring-slate-800">
            <!-- No allow-same-origin needed; fewer warnings, safer. -->
            <iframe id="wikiFrame" class="w-full h-[80vh] bg-white" sandbox="allow-scripts"></iframe>
          </div>
          <p class="mt-2 text-xs text-slate-400">
            Content Â© Old School RuneScape Wiki contributors (CC BY-SA).
          </p>
        </div>
        
        <!-- Sidebar (25%) -->
        <div class="w-80 flex-shrink-0">
          <!-- Game Stats -->
          <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-lg font-semibold text-yellow-400">Game Stats</h3>
              <button id="btnNew" class="px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">New round</button>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="bg-slate-700 rounded p-2">
                <div class="text-slate-400">Clicks</div>
                <div class="font-bold text-yellow-400" id="clicks">0</div>
              </div>
              <div class="bg-slate-700 rounded p-2">
                <div class="text-slate-400">Time</div>
                <div class="font-bold text-purple-400" id="timer">0:00</div>
              </div>
            </div>
          </div>
          
          <!-- Destination Info -->
          <div id="destinationInfo" class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-4">
              <h2 class="text-xl font-bold flex-1">Target Page:</h2>
            <div class="flex items-center gap-3 mb-3">
              <div id="destImage" class="hidden">
                <img id="destImageSrc" class="w-16 h-16 object-contain rounded-lg" alt="Destination image">
              </div>
              <a href="" class="text-2xl font-bold text-green-400 flex-1 hover:text-green-300" id="destTitle" target="_blank"></a>
            </div>
            <p id="destDescription" class="text-slate-300 text-sm leading-relaxed">
              Click "New round" to start a game and see your destination here.
            </p>
          </div>
          
          <!-- Navigation History -->
          <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
            <h3 class="text-lg font-semibold text-amber-400 mb-3">Your Path</h3>
            <div id="pathHistory" class="space-y-2 max-h-96 overflow-y-auto">
              <p class="text-slate-400 text-sm">No pages visited yet.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile iframe (full width) -->
      <div class="block lg:hidden">
        <div class="rounded-xl overflow-hidden shadow ring-1 ring-slate-800">
          <iframe id="wikiFrameMobile" class="w-full h-[70vh] bg-white" sandbox="allow-scripts"></iframe>
        </div>
        <p class="mt-2 text-xs text-slate-400">
          Content Â© Old School RuneScape Wiki contributors (CC BY-SA).
        </p>
      </div>
    </div>
  </main>

  <!-- Win Modal -->
  <div id="winModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="hideWinModal()">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-xl" onclick="event.stopPropagation()">
      <div class="text-center">
        <h2 class="text-2xl font-bold text-yellow-400 mb-4">You Won!</h2>
        <div class="flex justify-between items-center mb-6">
          <div class="text-left">
            <h3 class="text-sm font-semibold text-slate-300 mb-2">Your Path:</h3>
            <div id="winPathSteps" class="text-xs text-slate-400 space-y-1"></div>
          </div>
          <div class="text-right self-start">
            <p class="text-slate-300"><span id="winClicks" class="font-bold text-yellow-400"></span> clicks</p>
            <p class="text-slate-300">Time: <span id="winTime" class="font-bold text-purple-400"></span></p>
          </div>
        </div>

        <div class="mb-6 text-center">
          <h3 class="text-lg font-semibold text-slate-300 mb-2">Challenge Your Friends!</h3>
          <p class="text-sm text-slate-400">Share this exact challenge and see if your friends can beat your score.</p>
        </div>
        
        <div class="space-y-3">
          <button id="btnCopyLink" class="w-full px-4 py-2 bg-slate-600 hover:bg-slate-700 rounded-lg text-white font-semibold">
            Copy Challenge Link
          </button>
          <button id="btnShareTwitter" class="w-full px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-white font-semibold">
            Share on X
          </button>
          
          <button id="btnCloseWin" class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-semibold">
            New Round
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="footer.js"></script>

  <script>
  const API  = 'https://oldschool.runescape.wiki/api.php';
  const SITE = 'https://oldschool.runescape.wiki';

  let startTitle=null, targetTitle=null, currentTitle=null;
  let clickCount=0, startTimeMs=0, timerInterval=null, path=[];
  
  // URL parameter handling
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      start: params.get('start'),
      target: params.get('target')
    };
  }
  
  function setUrlParams(start, target) {
    const url = new URL(window.location);
    url.searchParams.set('start', start);
    url.searchParams.set('target', target);
    window.history.replaceState({}, '', url);
  }
  
  function clearUrlParams() {
    const url = new URL(window.location);
    url.searchParams.delete('start');
    url.searchParams.delete('target');
    window.history.replaceState({}, '', url);
  }

  function fmtTime(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60); return `${m}:${String(s%60).padStart(2,'0')}`; }
  function startTimer(){ 
    stopTimer(); 
    startTimeMs=Date.now(); 
    timerInterval=setInterval(()=>{
      const timeStr = fmtTime(Date.now()-startTimeMs);
      document.getElementById('timer').textContent = timeStr;
      document.getElementById('timerMobile').textContent = timeStr;
    },250); 
  }
  function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; }
  async function j(url){ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function randTitle(){ const d=await j(`${API}?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*`); return d.query.random[0].title; }
  
  // Check if a title is too niche or problematic
  function isGoodTitle(title) {
    // Skip disambiguation pages
    if (title.includes('(disambiguation)') || title.includes('(Disambiguation)')) {
      return false;
    }
    
    // Skip transcript pages
    if (title.toLowerCase().includes('transcript')) {
      return false;
    }

    if (title.toLowerCase().includes('clue scroll')) {
      return false;
    }
    
    // Skip money making guide pages
    if (title.toLowerCase().includes('money making guide')) {
      return false;
    }
    
    // Skip any date/year patterns
    if (/\d{4}/.test(title)) {
      return false;
    }
    
    return true;
  }
  async function norm(t){ const d=await j(`${API}?action=query&redirects=1&titles=${encodeURIComponent(t)}&format=json&origin=*`); const id=Object.keys(d.query.pages)[0]; return d.query.pages[id].title; }
  
  // Update path history display
  function updatePathHistory() {
    // Update desktop path history
    const pathHistory = document.getElementById('pathHistory');
    if (path.length === 0) {
      pathHistory.innerHTML = '<p class="text-slate-400 text-sm">No pages visited yet.</p>';
    } else {
      pathHistory.innerHTML = path.map((title, index) => {
        const isCurrent = index === path.length - 1;
        const isStart = index === 0;
        const isTarget = title === targetTitle;
        
        let bgClass = 'bg-slate-700';
        let textClass = 'text-slate-300';
        
        if (isCurrent) {
          bgClass = 'bg-amber-600';
          textClass = 'text-white';
        } else if (isStart) {
          bgClass = 'bg-green-600';
          textClass = 'text-white';
        } else if (isTarget) {
          bgClass = 'bg-yellow-600';
          textClass = 'text-white';
        }
        
        return `
          <button onclick="goToPage(${index})" 
                  class="w-full text-left p-2 rounded ${bgClass} ${textClass} hover:opacity-80 transition-opacity text-sm">
            ${index + 1}. ${title}
          </button>
        `;
      }).join('');
    }

    // Update mobile path history
    const pathHistoryMobile = document.getElementById('pathHistoryMobile');
    if (path.length === 0) {
      pathHistoryMobile.innerHTML = '<p class="text-slate-400 text-xs">No pages visited yet.</p>';
    } else {
      pathHistoryMobile.innerHTML = path.map((title, index) => {
        const isCurrent = index === path.length - 1;
        const isStart = index === 0;
        const isTarget = title === targetTitle;
        
        let bgClass = 'bg-slate-700';
        let textClass = 'text-slate-300';
        
        if (isCurrent) {
          bgClass = 'bg-amber-600';
          textClass = 'text-white';
        } else if (isStart) {
          bgClass = 'bg-green-600';
          textClass = 'text-white';
        } else if (isTarget) {
          bgClass = 'bg-yellow-600';
          textClass = 'text-white';
        }
        
        return `
          <button onclick="goToPage(${index})" 
                  class="w-full text-left p-1 rounded ${bgClass} ${textClass} hover:opacity-80 transition-opacity text-xs">
            ${index + 1}. ${title}
          </button>
        `;
      }).join('');
    }
  }
  
  // Navigate to a specific page in history
  function goToPage(index) {
    if (index >= 0 && index < path.length) {
      // Render the selected page without modifying path or click count
      renderPage(path[index]);
      updatePathHistory();
    }
  }
  
  // Fetch target preview with image
  async function fetchTargetPreview(title) {
    try {
      // Fetch page content
      const url = `${API}?action=parse&format=json&formatversion=2&redirects=1` +
                  `&page=${encodeURIComponent(title)}&prop=text|images&section=0&origin=*`;
      const data = await j(url);
      
      // Extract first paragraph from the HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = data.parse.text;
      
      // Find the first paragraph (usually in .mw-parser-output > p)
      const firstP = tempDiv.querySelector('.mw-parser-output p');
      if (firstP) {
        // Clean up the text (remove HTML tags, limit length)
        let text = firstP.textContent.trim();
        if (text.length > 200) {
          text = text.substring(0, 200) + '...';
        }
        
        // Update destination info (desktop)
        document.getElementById('destTitle').textContent = title;
        document.getElementById('destTitle').href = `${SITE}/${title}`;
        document.getElementById('destDescription').textContent = text;
        
        // Update destination info (mobile)
        document.getElementById('destTitleMobile').textContent = title;
        document.getElementById('destTitleMobile').href = `${SITE}/${title}`;
        document.getElementById('destDescriptionMobile').textContent = text;
        
        // Try to find and display an image
        const images = data.parse.images || [];
        
        // Find an image that's not within a messagebox
        let imageFile = null;
        for (const img of images) {
          if (img.toLowerCase().includes('.png') || 
              img.toLowerCase().includes('.jpg') || 
              img.toLowerCase().includes('.jpeg') ||
              img.toLowerCase().includes('.webp')) {
            
            // Check if this image is within a messagebox element
            const imgElement = tempDiv.querySelector(`img[src*="${img.replace(/ /g, '_')}"]`);
            if (imgElement) {
              const messageboxParent = imgElement.closest('.messagebox');
              if (!messageboxParent) {
                imageFile = img;
                break;
              }
            } else {
              // If we can't find the img element, assume it's safe to use
              imageFile = img;
              break;
            }
          }
        }
        
        if (imageFile) {
          const imageUrl = `https://oldschool.runescape.wiki/images/${imageFile.replace(/ /g, '_')}`;
          // Update desktop image
          document.getElementById('destImageSrc').src = imageUrl;
          document.getElementById('destImage').classList.remove('hidden');
          // Update mobile image
          document.getElementById('destImageSrcMobile').src = imageUrl;
          document.getElementById('destImageMobile').classList.remove('hidden');
        } else {
          document.getElementById('destImage').classList.add('hidden');
          document.getElementById('destImageMobile').classList.add('hidden');
        }
      }
    } catch (err) {
      console.log('Could not fetch target preview:', err);
      // Update desktop elements
      document.getElementById('destTitle').textContent = 'Destination';
      document.getElementById('destDescription').textContent = 'Could not load destination info.';
      document.getElementById('destImage').classList.add('hidden');
      // Update mobile elements
      document.getElementById('destTitleMobile').textContent = 'Destination';
      document.getElementById('destDescriptionMobile').textContent = 'Could not load destination info.';
      document.getElementById('destImageMobile').classList.add('hidden');
    }
  }

  // Build a complete HTML doc for the iframe using the wiki's own headhtml bundle
  function buildSrcDoc({ html, head }) {
    const safeHead = head.replace(/<script\b[\s\S]*?<\/script>/gi, ''); // keep only link/style
    return `<!doctype html>
<html class="client-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<base href="${SITE}/">
${safeHead}

</head>
<body class="mediawiki skin-vector skin-vector-legacy">
<div id="content" class="mw-body">
  <div id="mw-content-text" class="mw-body-content">
    ${html}  <!-- includes .mw-parser-output -->
  </div>
</div>
<script>
(function(){
  // Hydrate lazy/protocol-relative images
  function fixImages(root){
    root.querySelectorAll('img').forEach(function(img){
      var ds=img.getAttribute('data-src'), dss=img.getAttribute('data-srcset');
      if(ds && !img.src) img.src = ds;
      if(dss && !img.srcset) img.srcset = dss;
      if(img.src && img.src.startsWith('//')) img.src = 'https:' + img.src;
      if(img.srcset && img.srcset.includes('//')) img.srcset = img.srcset.replace(/(^|,\\s*)\\/\\//g,'$1https://');
    });
  }
  fixImages(document);

  // Intercept internal wiki links and send target title to parent
  document.addEventListener('click', function(e){
    var a = e.target.closest('a'); if(!a) return;
    var href = a.getAttribute('href')||'';
    
    // Handle anchor links (internal page navigation) - handle manually to avoid base href issues
    if(href.startsWith('#')) {
      console.log('Anchor link detected, handling manually');
      e.preventDefault();
      // Find the target element and scroll to it
      var targetId = href.substring(1);
      var targetElement = document.getElementById(targetId) || document.querySelector('[name="' + targetId + '"]');
      if(targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth' });
      }
      return; // Don't log or send message
    }
    
    // Log all non-anchor link attempts
    console.log('Link clicked:', href);
    parent.postMessage({type:'link-log', href:href}, '*');
    
    // Handle external links
    if (/^(https?:)?\\/\\//i.test(href) && !href.startsWith('${SITE}/w/') && !href.startsWith('/w/')) {
      console.log('External link detected, allowing normal navigation');
      return;
    }
    
    try{
      var u = new URL(href, '${SITE}');
      if(!u.pathname.startsWith('/w/')) {
        console.log('Non-wiki link detected, allowing normal navigation');
        return;
      }
      var title = u.searchParams.get('title') || decodeURIComponent(u.pathname.replace(/^\\/w\\//,'')).replace(/_/g,' ');
      if(!title) {
        console.log('No title found in link, allowing normal navigation');
        return;
      }
      console.log('Wiki navigation to:', title);
      e.preventDefault();
      parent.postMessage({type:'wiki-nav', title:title}, '*');
    }catch(err){
      console.log('Error parsing link:', err, 'allowing normal navigation');
    }
  }, true);
})();
</scr` + `ipt>
</body>
</html>`;
  }

  // Fetch + render a page into the iframe
  async function renderPage(title){
    const url = `${API}?action=parse&format=json&formatversion=2&redirects=1` +
                `&page=${encodeURIComponent(title)}&prop=text|headhtml&useskin=vector&origin=*`;
    const data = await j(url);

    const html  = data.parse.text;      // article HTML (.mw-parser-output inside)
    const head  = data.parse.headhtml;  // full skin/site TemplateStyles bundle
    const canon = data.parse.title;

    currentTitle = canon;
    if(!path.length) path=[canon];

    // Update both desktop and mobile iframes
    const srcDoc = buildSrcDoc({ html, head });
    document.getElementById('wikiFrame').srcdoc = srcDoc;
    document.getElementById('wikiFrameMobile').srcdoc = srcDoc;
    
    // Update path history display
    updatePathHistory();

    // Win check
    if (targetTitle && currentTitle === targetTitle) {
      stopTimer();
      showWinModal();
    }
  }

  // Receive nav messages from iframe
  window.addEventListener('message', (ev)=>{
    if(!ev?.data) return;
    
    // Handle link logging
    if(ev.data.type === 'link-log') {
      console.log('Link attempted:', ev.data.href);
      // You can also display this in the UI if desired
      // For now, just logging to console
    }
    
    // Handle wiki navigation
    if(ev.data.type === 'wiki-nav') {
      const nextTitle = ev.data.title;
      clickCount++; 
      document.getElementById('clicks').textContent = String(clickCount);
      document.getElementById('clicksMobile').textContent = String(clickCount);
      path.push(nextTitle);
      renderPage(nextTitle);
    }
  });

  async function newRound({keepStart=false, keepTarget=false} = {}){
    stopTimer(); clickCount=0; path=[];
    document.getElementById('clicks').textContent='0';
    document.getElementById('clicksMobile').textContent='0';
    document.getElementById('timer').textContent='0:00';
    document.getElementById('timerMobile').textContent='0:00';
    const loadingHtml = '<!doctype html><body style="font:14px system-ui;padding:16px;color:#64748b">Loadingâ€¦</body>';
    document.getElementById('wikiFrame').srcdoc = loadingHtml;
    document.getElementById('wikiFrameMobile').srcdoc = loadingHtml;

    // Get good titles (not too niche)
    if(!keepStart) {
      do { startTitle = await norm(await randTitle()); } while(!isGoodTitle(startTitle));
    }
    if(!keepTarget){
      do { 
        targetTitle = await norm(await randTitle()); 
      } while(targetTitle === startTitle || !isGoodTitle(targetTitle));
    }


    startTimer();
    await renderPage(startTitle);
    
    // Fetch and display target preview
    await fetchTargetPreview(targetTitle);
    
    // Update path history
    updatePathHistory();
  }

  // Win modal functions
  function showWinModal() {
    const modal = document.getElementById('winModal');
    const timeElapsed = Date.now() - startTimeMs;
    
    document.getElementById('winClicks').textContent = clickCount;
    document.getElementById('winTime').textContent = fmtTime(timeElapsed);
    
    // Display path steps
    const pathSteps = document.getElementById('winPathSteps');
    if (path.length > 0) {
      pathSteps.innerHTML = path.map((title, index) => {
        return `
          <div class="flex items-center">
            <span class="text-slate-500">${index + 1}.</span>
            <span class="ml-1">${title}</span>
          </div>
        `;
      }).join('');
    } else {
      pathSteps.innerHTML = '<p class="text-slate-500">No path recorded</p>';
    }
    
    modal.classList.remove('hidden');
  }
  
  function hideWinModal() {
    document.getElementById('winModal').classList.add('hidden');
  }
  
  function generateChallengeLink() {
    const url = new URL(window.location);
    url.searchParams.set('start', startTitle);
    url.searchParams.set('target', targetTitle);
    return url.toString();
  }
  
  function shareToTwitter() {
    const timeElapsed = Date.now() - startTimeMs;
    const text = `I completed the OSRS Wiki Game from "${startTitle}" to "${targetTitle}" in ${clickCount} clicks! ðŸŽ® Can you beat my time?`;
    const url = generateChallengeLink();
    const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
    window.open(shareUrl, '_blank');
  }
  
  
  function copyChallengeLink() {
    const link = generateChallengeLink();
    navigator.clipboard.writeText(link).then(() => {
      const btn = document.getElementById('btnCopyLink');
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    });
  }
  
  // Event handlers
  document.getElementById('btnNew').onclick     = () => newRound();
  document.getElementById('btnNewMobile').onclick = () => newRound();
  document.getElementById('btnCloseWin').onclick = () => { hideWinModal(); newRound(); };
  document.getElementById('btnShareTwitter').onclick = shareToTwitter;
  document.getElementById('btnCopyLink').onclick = copyChallengeLink;
  
  // Initialize with URL parameters if present
  const urlParams = getUrlParams();
  if (urlParams.start && urlParams.target) {
    startTitle = urlParams.start;
    targetTitle = urlParams.target;
    startTimer();
    renderPage(startTitle);
    fetchTargetPreview(targetTitle);
  } else {
    newRound();
  }
  </script>
</body>
</html>
